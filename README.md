# The Zephyr.js Project

This purpose of this project is to provide a JavaScript API and environment
for IoT development on low-memory systems, using JerryScript and the Zephyr
operating system.

This code requires a local copy of JerryScript and Zephyr source, and we
will upstream code to those projects as appropriate, but this repo is for
everything else.

## File Descriptions
```zjs-env.sh``` - Source this file to set environment variables and path to be
able to use tools from ```scripts/``` anywhere.

## Subdirectories
- ```arc/``` - Contains sensor subsystem code for ARC side of the Arduino 101.
- ```deps/``` - Contains dependency repos and scripts for working with them.
- ```outdir/``` - Directory generated by build, can be safely removed.
- ```samples/``` - Sample JavaScript files that can be built with make JS=<path>.
- ```scripts/``` - Subdirectory containing tools useful during development.
- ```src/``` - JS API bindings for JerryScript written directly on top of Zephyr.

## One-Time Environment Setup
Download the [latest Zephyr SDK] (https://nexus.zephyrproject.org/content/repositories/releases/org/zephyrproject/zephyr-sdk/), then:
```
$ chmod +x zephyr-sdk-0.*.*-i686-setup.run
$ sudo ./zephyr-sdk-0.*.*-i686-setup.run
```

From now on, we assume you have cloned this git repo and are working from its
root directory.

Next, set up the Zephyr SDK environment variables. It is recommended that you
add the following two lines to your ```.bashrc``` so that you don't have to type
them again. If you installed your Zephyr SDK elsewhere, adjust as needed.
```
$ export ZEPHYR_GCC_VARIANT=zephyr
$ export ZEPHYR_SDK_INSTALL_DIR=/opt/zephyr-sdk
```

This should be done for you automatically by the Makefile now, but to manually
check out the other repos Zephyr.js depends on:

```
$ cd deps
$ ./getrepos
```

Later, to manually update them to the latest compatible code:
```
$ cd deps
$ ./update
```

## Set Up a New Shell

Whenever you open a new terminal to work with this repo, you need to set up
environment variables.

First, set up the Zephyr OS variables:
```
$ source deps/zephyr/zephyr-env.sh
```

If you wish to use a Zephyr tree elsewhere on your system, source its
zephyr-env.sh file instead.

Next, set up the Zephyr.js environment variables:
```
$ source zjs-env.sh
```

Note: If you are using Zephyr.js with an Arduino101 that you have converted to
a 256KB X86 partition (see below), you should pass 256 to this command:
```
$ source zjs-env.sh 256
```

The command will display the current expected partition size to remind you of
the expected target.

### JS Minifier

To save space it is recommended to use a minifier. In convert.sh, the script
used to encode your JS into a source file, we use uglifyjs. This can be
downloaded by doing:
```
sudo apt-get install node-uglify
```

## Getting more space on your Arduino 101
By default, Arduino 101 comes with a **144K** X86 partition, but we're able to
pretty safely increase it to **256K**. You should only use the ```dfu-util```
method of flashing after this.

The easiest way to do this is to use a flashpack.zip file that I can provide
you (geoff@linux.intel.com). I need to make sure of the license details before
I add it to the repo.

The default build settings currently expect you to be using the 256KB partition.

## Building system images
The Zephyr.js project uses a top-level Makefile to control the building of
code from the project itself as well as the JerryScript and Zephyr projects it
depends on.

To see the available make commands, type:

```
$ make help
```

## Build the ARC image
On Arduino 101, there are two embedded microcontrollers, an X86 and an ARC one.
If you only need the x86 side, you can disable ARC with CONFIG_ARC_INIT=n in
the Zephyr prj.conf. Otherwise, you need a working image running on it.

For the best flexibility in using Zephyr.js, you should build and install our
project's ARC image. Some of the APIs you can call from JavaScript won't work
until you have this server image running there (for now this is just AIO API).
This is because only the ARC MCU can perform certain functions, like converting
analog inputs to digital values.

We don't change the ARC engine code very often, so you only need to update this
occasionally. To build and install the ARC image, do this:

```
$ make arc
$ make dfu-arc
```

(As always with DFU, you will need to reset the device a few seconds before you
attempt the DFU command, or it will fail.)

## Build the *Hello World* sample
```
$ make JS=samples/HelloWorld.js
```

This will build the system image, resulting in outdir/zephyr.bin as the final
output. To flash this to your device with dfu-util, first press the Master Reset
button on your Arduino 101, and about three seconds later type:

```
$ make dfu
```

There is a window of about five seconds where the DFU server is available,
starting a second or two after the device resets.

Now the x86 image on your device has been updated. Press the Master Reset button
one more time to boot your new image.

## Build other samples
The other samples may require some hardware to be set up and connected; read
the top of each JS file, but then simply pass in the path to the JS file to make
as with ```HelloWorld.js``` above.

## FRDM-K64F Platform

See the [Zephyr Wiki] (https://wiki.zephyrproject.org/view/NXP_FRDM-K64F) for general information about Zephyr on the FRDM-K64F.

The instructions below are assuming Ubuntu 14.04 on the host PC.

Connect a micro-USB cable from the device to your PC.

If you hit the Reset switch and wait about five seconds, you should be able to
start up a serial console. Either:

...
$ screen /dev/ttyACM0 115200
...
or
...
$ minicom -D /dev/ttyACM0
...

worked for me, but I typically had to try either command several times before it
would work. The benefit of minicom is it will keep running even if you unplug
the cable and then plug it back in later.

(Check your dmesg output or watch your /dev directory to know what device it
shows up as.)

Then, follow [these instructions] (https://developer.mbed.org/handbook/Firmware-FRDM-K64F) to update your firmware.

Next, you can try to build Zephyr.js for the platform:
...
$ make BOARD=frdm_k64f JS=samples/HelloWorld.js
$ cp outdir/zephyr.bin /media/<USERNAME>/MBED/

After you copy the new .bin file to that directory, the device will reboot,
blink an LED quickly as it writes the image somewhere, and then you should see
the device reconnect as a USB storage device to your PC. Then you can press the
Reset button to run the Zephyr image. You should see "Hello, Zephyr.js world!"
output on the serial console in less than a second.

If something doesn't work, you may want to establish that you're able to
upload the K64F [hello world application] (https://developer.mbed.org/platforms/FRDM-K64F/#flash-a-project-binary).

Then, you could try the Zephyr hello_world sample to narrow down the problem:
...
$ cd deps/zephyr/samples/hello_world/nanokernel
$ make pristine && make BOARD=frdm_k64f
$ cp outdir/zephyr.bin /media/<USERNAME>/MBED/
...

Using the same procedure as above, once you hit Reset you should see
"Hello World!" within a second on your serial console.
